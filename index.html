<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¡Œæ”¿æ›¸å£«è©¦é¨“ æ”»ç•¥ãƒŠãƒ“</title>
    <style>
        :root {
            --primary: #2c3e50;
            --accent: #e67e22;
            --danger: #e74c3c;
            --info: #3498db;
            --bg: #f5f6fa;
            --card-bg: #ffffff;
            --text: #333;
        }
        body {
            font-family: "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            line-height: 1.6;
            -webkit-text-size-adjust: 100%;
        }
        h1 { text-align: center; color: var(--primary); font-size: 1.5rem; margin-bottom: 20px; }
        
        .controls {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* 16pxãƒ•ã‚©ãƒ³ãƒˆã§ã‚ºãƒ¼ãƒ é˜²æ­¢ */
        input, select, button {
            padding: 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box;
        }

        button {
            background-color: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            font-weight: bold;
            transition: opacity 0.2s;
        }
        button:hover { opacity: 0.9; }
        
        /* ãƒœã‚¿ãƒ³ã®è‰²åˆ†ã‘ */
        .btn-review { background-color: var(--danger); }
        .btn-break { background-color: var(--info); } /* æ¯æŠœããƒœã‚¿ãƒ³ */
        .btn-speak { 
            background-color: transparent; 
            color: var(--accent); 
            border: 1px solid var(--accent);
            padding: 5px 10px;
            font-size: 0.9rem;
            margin-left: 10px;
        }
        
        .mode-switch {
            display: flex;
            gap: 10px;
        }
        .mode-btn {
            flex: 1;
            background-color: #ddd;
            color: #555;
        }
        .mode-btn.active {
            background-color: var(--accent);
            color: white;
        }

        #content-area { display: grid; gap: 15px; }

        .card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            border-left: 5px solid var(--primary);
            position: relative;
        }
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .subject-badge {
            font-size: 0.8rem;
            background: #eee;
            padding: 2px 8px;
            border-radius: 4px;
            color: #666;
        }
        
        .review-check {
            font-size: 0.9rem;
            color: #888;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid #ddd;
            padding: 2px 8px;
            border-radius: 15px;
            -webkit-tap-highlight-color: transparent;
        }
        .review-check.checked {
            color: var(--danger);
            border-color: var(--danger);
            background-color: #fff0f0;
            font-weight: bold;
        }
        
        .term-title {
            font-weight: bold;
            font-size: 1.2rem;
            color: var(--primary);
            display: flex;
            align-items: center;
        }
        .legal-detail {
            margin-top: 10px;
            padding: 10px;
            background: #fff3cd;
            border-radius: 5px;
            font-size: 0.9rem;
            display: none;
        }
        .legal-detail.show { display: block; }
        
        .quiz-options button {
            display: block;
            width: 100%;
            margin-top: 5px;
            background: white;
            color: var(--text);
            border: 1px solid #ccc;
            text-align: left;
        }
        .quiz-options button:hover { background: #f0f0f0; }
        .result-msg { margin-top: 10px; font-weight: bold; }
        .correct { color: #27ae60; }
        .incorrect { color: #c0392b; }

        /* ãŠä¾›ã‚¬ãƒãƒ£ã®ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— */
        #modal-overlay {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }
        #modal-box {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 80%;
            max-width: 300px;
            animation: popIn 0.3s ease;
        }
        #companion-result {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--accent);
            margin: 20px 0;
        }
        @keyframes popIn {
            from { transform: scale(0.8); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

    </style>
</head>
<body>

    <h1>è¡Œæ”¿æ›¸å£« åˆæ ¼ãƒ‘ã‚¹ãƒãƒ¼ãƒˆ</h1>

    <div class="controls">
        <button class="btn-break" onclick="showCompanion()">â˜•ï¸ ä»Šæ—¥ã®å‹‰å¼·ã®ãŠä¾›ã‚’æ±ºã‚ã‚‹</button>

        <div class="mode-switch" style="margin-top:10px;">
            <button class="mode-btn active" onclick="setMode('dictionary')">ç”¨èªè¾å…¸</button>
            <button class="mode-btn" onclick="setMode('quiz')">éå»å•æ¼”ç¿’</button>
        </div>

        <div id="dict-controls">
            <select id="subject-select-dict" onchange="refreshDict()" style="width:100%; margin-top:10px;">
                <option value="all">å…¨ç§‘ç›®</option>
                <option value="æ†²æ³•">æ†²æ³•</option>
                <option value="æ°‘æ³•">æ°‘æ³•</option>
                <option value="è¡Œæ”¿æ³•">è¡Œæ”¿æ³•</option>
                <option value="å•†æ³•ãƒ»ä¼šç¤¾æ³•">å•†æ³•ãƒ»ä¼šç¤¾æ³•</option>
                <option value="åŸºç¤æ³•å­¦">åŸºç¤æ³•å­¦</option>
            </select>
            <input type="text" id="search-box" placeholder="ç”¨èªã‚’æ¤œç´¢..." style="width: 100%; margin-top:10px;" oninput="refreshDict()">
        </div>

        <div id="quiz-controls" style="display:none;">
            <select id="subject-select-quiz" style="width:100%; margin-top:10px;">
                <option value="all">å…¨ç§‘ç›®</option>
                <option value="æ†²æ³•">æ†²æ³•</option>
                <option value="æ°‘æ³•">æ°‘æ³•</option>
                <option value="è¡Œæ”¿æ³•">è¡Œæ”¿æ³•</option>
                <option value="å•†æ³•ãƒ»ä¼šç¤¾æ³•">å•†æ³•ãƒ»ä¼šç¤¾æ³•</option>
                <option value="åŸºç¤æ³•å­¦">åŸºç¤æ³•å­¦</option>
            </select>
            
            <div style="display:flex; gap:5px; margin-top:10px;">
                <select id="quiz-count" style="flex:1;">
                    <option value="1">1å•</option>
                    <option value="3">3å•</option>
                    <option value="5">5å•</option>
                    <option value="10">10å•</option>
                </select>
                <button onclick="startQuiz('normal')" style="flex:2;">å‡ºé¡Œã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            </div>
            
            <button onclick="startQuiz('review')" class="btn-review" style="width:100%; margin-top:10px;">
                ğŸ”¥ è‹¦æ‰‹ãªå•é¡Œã ã‘å¾©ç¿’ (<span id="review-count">0</span>å•)
            </button>
        </div>
    </div>

    <div id="content-area"></div>

    <div id="modal-overlay" onclick="closeModal()">
        <div id="modal-box" onclick="event.stopPropagation()">
            <h3>ä»Šæ—¥ã®ãŠä¾›ã¯...</h3>
            <div id="companion-result"></div>
            <p style="font-size:0.9rem; color:#666;">ã“ã‚Œã‚’ç”¨æ„ã—ã¦é ‘å¼µã‚ã†ï¼</p>
            <button onclick="closeModal()">OK</button>
        </div>
    </div>

<script>
// ==========================================
// 1. ãƒ‡ãƒ¼ã‚¿ç®¡ç† & åˆæœŸåŒ–
// ==========================================
let termsData = [];
let quizData = [];
let weakPointIds = [];

// ãŠä¾›ãƒªã‚¹ãƒˆ
const companions = [
    "ãƒ›ãƒƒãƒˆãƒŸãƒ«ã‚¯ ğŸ¥›",
    "ã‚³ãƒ¼ãƒ’ãƒ¼ â˜•ï¸",
    "ã‚³ã‚³ã‚¢ ğŸ«",
    "ã‚¢ã‚¤ã‚¹ãƒ†ã‚£ãƒ¼ ğŸ¹",
    "ã‚°ãƒ¬ãƒ¼ãƒ—ãƒ•ãƒ«ãƒ¼ãƒ„ ğŸŠ",
    "ãƒãƒ§ã‚³ãƒ¬ãƒ¼ãƒˆ ğŸ«",
    "ã‚¯ãƒ©ã‚·ãƒƒã‚¯éŸ³æ¥½ï¼ˆã‚·ãƒ¥ãƒ¼ãƒ™ãƒ«ãƒˆï¼‰ ğŸ»",
    "ãƒãƒ¼ãƒ–ã®ãŠé¦™ ğŸŒ¿",
    "ãŠã«ãã‚Š ğŸ™",
    "ãƒ©ã‚¸ã‚ª ğŸ“»",
    "æ·±å‘¼å¸ 3å› ğŸ˜®â€ğŸ’¨",
    "è»½ã„ã‚¹ãƒˆãƒ¬ãƒƒãƒ ğŸ™†"
];

function loadWeakPoints() {
    const saved = localStorage.getItem('gyosei_weak_points');
    if (saved) {
        weakPointIds = JSON.parse(saved);
    }
    updateReviewCount();
}

function saveWeakPoints() {
    localStorage.setItem('gyosei_weak_points', JSON.stringify(weakPointIds));
    updateReviewCount();
}

function updateReviewCount() {
    const btnSpan = document.getElementById('review-count');
    if(btnSpan) btnSpan.textContent = weakPointIds.length;
}

async function loadData() {
    try {
        const resTerms = await fetch('./terms.json');
        termsData = await resTerms.json();
        const resQuiz = await fetch('./quiz.json');
        quizData = await resQuiz.json();

        loadWeakPoints();
        refreshDict();
        console.log("ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å®Œäº†");
    } catch (error) {
        console.error("èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);
        document.getElementById('content-area').innerHTML = '<p>ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚</p>';
    }
}

window.addEventListener('DOMContentLoaded', loadData);

// ==========================================
// 2. ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ & ã‚¬ãƒãƒ£æ©Ÿèƒ½
// ==========================================
let currentMode = 'dictionary';

function setMode(mode) {
    currentMode = mode;
    const btns = document.querySelectorAll('.mode-btn');
    const dictCtrl = document.getElementById('dict-controls');
    const quizCtrl = document.getElementById('quiz-controls');
    const container = document.getElementById('content-area');

    if(mode === 'dictionary') {
        btns[0].classList.add('active');
        btns[1].classList.remove('active');
        dictCtrl.style.display = 'block';
        quizCtrl.style.display = 'none';
        refreshDict();
    } else {
        btns[0].classList.remove('active');
        btns[1].classList.add('active');
        dictCtrl.style.display = 'none';
        quizCtrl.style.display = 'block';
        container.innerHTML = '<p style="text-align:center; color:#666;">æ¡ä»¶ã‚’é¸ã‚“ã§ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¦ãã ã•ã„ã€‚</p>';
        updateReviewCount();
    }
}

// ãŠä¾›ã‚¬ãƒãƒ£ãƒ­ã‚¸ãƒƒã‚¯
function showCompanion() {
    const result = companions[Math.floor(Math.random() * companions.length)];
    document.getElementById('companion-result').textContent = result;
    document.getElementById('modal-overlay').style.display = 'flex';
}

function closeModal() {
    document.getElementById('modal-overlay').style.display = 'none';
}

// ==========================================
// 3. èª­ã¿ä¸Šã’æ©Ÿèƒ½ (Text-to-Speech)
// ==========================================
function speakText(text) {
    // æ—¢ã«å–‹ã£ã¦ã„ãŸã‚‰æ­¢ã‚ã‚‹
    window.speechSynthesis.cancel();

    const uttr = new SpeechSynthesisUtterance(text);
    uttr.lang = "ja-JP"; // æ—¥æœ¬èªè¨­å®š
    uttr.rate = 1.0; // é€Ÿåº¦
    window.speechSynthesis.speak(uttr);
}


// ==========================================
// 4. ç”¨èªè¾å…¸ (Dictionary) æ©Ÿèƒ½
// ==========================================
function refreshDict() {
    const subject = document.getElementById('subject-select-dict').value;
    const keyword = document.getElementById('search-box').value.toLowerCase();
    const container = document.getElementById('content-area');
    container.innerHTML = '';

    const filtered = termsData.filter(item => {
        const matchSubject = subject === 'all' || item.subject === subject;
        const matchKey = item.term.toLowerCase().includes(keyword) || item.desc.toLowerCase().includes(keyword);
        return matchSubject && matchKey;
    });

    if(filtered.length === 0) {
        container.innerHTML = '<p>è©²å½“ã™ã‚‹ç”¨èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚</p>';
        return;
    }

    filtered.forEach(item => {
        let detailHtml = '';
        if (item.detail) {
            detailHtml = `
                <div class="legal-detail show">
                    <strong>ã€æ¡æ–‡ã€‘</strong> ${item.detail.article}<br>
                    <strong>ã€åˆ¤ä¾‹ç­‰ã€‘</strong> ${item.detail.case}
                </div>
            `;
        }
        
        // èª­ã¿ä¸Šã’ç”¨ãƒ†ã‚­ã‚¹ãƒˆä½œæˆ
        const speakContent = `${item.term}ã€‚${item.desc}`;

        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
            <div class="card-header">
                <span class="subject-badge">${item.subject}</span>
                <button class="btn-speak" onclick="speakText('${speakContent}')">ğŸ”Š è´ã</button>
            </div>
            <div class="term-title">${item.term}</div>
            <p>${item.desc}</p>
            ${detailHtml}
        `;
        container.appendChild(card);
    });
}


// ==========================================
// 5. ã‚¯ã‚¤ã‚º (Quiz) æ©Ÿèƒ½
// ==========================================
function startQuiz(type) {
    const container = document.getElementById('content-area');
    container.innerHTML = '';
    let candidates = [];

    if (type === 'review') {
        if (weakPointIds.length === 0) {
            container.innerHTML = '<p style="text-align:center;">ç¾åœ¨ã€å¾©ç¿’ãƒªã‚¹ãƒˆã¯ç©ºã§ã™ï¼<br>å„ªç§€ã§ã™ã­ï¼ğŸ‘</p>';
            return;
        }
        candidates = quizData.filter(q => weakPointIds.includes(q.id));
        const title = document.createElement('h3');
        title.style.textAlign = 'center';
        title.style.color = 'var(--danger)';
        title.textContent = `ğŸ”¥ è‹¦æ‰‹å…‹æœãƒ¢ãƒ¼ãƒ‰ (${candidates.length}å•)`;
        container.appendChild(title);
    } else {
        const subject = document.getElementById('subject-select-quiz').value;
        const count = parseInt(document.getElementById('quiz-count').value);
        candidates = quizData.filter(q => subject === 'all' || q.subject === subject);
        candidates = candidates.sort(() => Math.random() - 0.5).slice(0, count);

        if(candidates.length === 0) {
            container.innerHTML = '<p>æ¡ä»¶ã«åˆã†å•é¡ŒãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
            return;
        }
    }

    candidates.forEach((q, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        
        let optionsHtml = '';
        q.options.forEach((opt, idx) => {
            optionsHtml += `<button onclick="checkAnswer(this, ${q.id}, ${idx})">${idx + 1}. ${opt}</button>`;
        });

        const isWeak = weakPointIds.includes(q.id);
        const checkClass = isWeak ? 'review-check checked' : 'review-check';
        const checkText = isWeak ? 'âœ” å¾©ç¿’ãƒªã‚¹ãƒˆå…¥ã‚Š' : 'å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ ';

        // èª­ã¿ä¸Šã’ç”¨ãƒ†ã‚­ã‚¹ãƒˆ
        const speakContent = `ç¬¬${index + 1}å•ã€‚${q.question}`;

        card.innerHTML = `
            <div class="card-header">
                <span class="subject-badge">ç¬¬${index + 1}å• (${q.subject})</span>
                <span class="${checkClass}" id="check-${q.id}" onclick="toggleWeakPoint(${q.id})">
                    ${checkText}
                </span>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                <p style="font-weight:bold; width:80%;">${q.question}</p>
                <button class="btn-speak" onclick="speakText('${speakContent}')">ğŸ”Š</button>
            </div>
            <div class="quiz-options" id="options-${q.id}">
                ${optionsHtml}
            </div>
            <div class="result-msg" id="result-${q.id}"></div>
        `;
        container.appendChild(card);
    });
}

function checkAnswer(btn, qId, userIdx) {
    const qData = quizData.find(q => q.id === qId);
    const resultDiv = document.getElementById(`result-${qId}`);
    const parent = document.getElementById(`options-${qId}`);
    parent.querySelectorAll('button').forEach(b => b.disabled = true);

    if(userIdx === qData.answer) {
        btn.style.background = '#d4edda';
        btn.style.borderColor = '#c3e6cb';
        resultDiv.innerHTML = `<span class="correct">æ­£è§£ï¼â­•ï¸</span><br>${qData.explanation}`;
        // æ­£è§£æ™‚ã®èª­ã¿ä¸Šã’ï¼ˆè§£èª¬ã‚’èª­ã‚€ï¼‰
        // speakText("æ­£è§£ã§ã™ã€‚" + qData.explanation.replace(/<br>/g, '')); 
        // â†‘â€»ã‚¦ã‚¶ã„ã‹ã‚‚ã—ã‚Œãªã„ã®ã§ã€è‡ªå‹•èª­ã¿ä¸Šã’ã¯ä¸€æ—¦OFFã«ã—ã¦ã„ã¾ã™
    } else {
        btn.style.background = '#f8d7da';
        btn.style.borderColor = '#f5c6cb';
        parent.querySelectorAll('button')[qData.answer].style.background = '#d4edda';
        resultDiv.innerHTML = `<span class="incorrect">æ®‹å¿µ...âŒ</span><br>${qData.explanation}`;
        addWeakPoint(qId);
    }
}

// å¾©ç¿’ãƒªã‚¹ãƒˆç®¡ç†
function addWeakPoint(id) {
    if (!weakPointIds.includes(id)) {
        weakPointIds.push(id);
        saveWeakPoints();
        updateCheckDisplay(id, true);
    }
}
function toggleWeakPoint(id) {
    if (weakPointIds.includes(id)) {
        weakPointIds = weakPointIds.filter(wid => wid !== id);
        updateCheckDisplay(id, false);
    } else {
        weakPointIds.push(id);
        updateCheckDisplay(id, true);
    }
    saveWeakPoints();
}
function updateCheckDisplay(id, isActive) {
    const el = document.getElementById(`check-${id}`);
    if (!el) return;
    if (isActive) {
        el.className = 'review-check checked';
        el.textContent = 'âœ” å¾©ç¿’ãƒªã‚¹ãƒˆå…¥ã‚Š';
    } else {
        el.className = 'review-check';
        el.textContent = 'å¾©ç¿’ãƒªã‚¹ãƒˆã«è¿½åŠ ';
    }
}

</script>

</body>
</html>
